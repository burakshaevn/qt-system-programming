# Двухпросмотровый ассемблер с раздельным ассемблированием

## Описание

Приложение представляет собой **двухпросмотровый ассемблер для перемещаемых программ с поддержкой раздельного ассемблирования** с графическим интерфейсом, написанный на C++ с использованием Qt. 

Программа реализует полный цикл создания перемещаемого объектного кода с поддержкой модульной структуры и внешних связей между модулями.

## Пример
| Прямая адресация | Смешанный случай |
|--------------|--------|
| <img width="1240" height="872" alt="image" src="https://github.com/user-attachments/assets/ec352487-83b8-4bf9-b1f3-5570f5f04612" /> | <img width="1240" height="872" alt="image" src="https://github.com/user-attachments/assets/ac377024-ac7d-483b-a811-c78fb5aa6ee0" /> |
| Рис. 1 | Рис. 2 |

### Базовая функциональность
- Ввод исходного кода ассемблера
- Настройка таблицы команд (ТКО)
- Выполнение первого прохода ассемблера (создание ТСИ)
- Выполнение второго прохода ассемблера (генерация объектного кода)
- Создание таблицы настройки для поддержки загрузки по любому адресу
- Поддержка прямой, относительной и смешанной адресации
- Отображение ошибок и детальной информации о трансляции

### Возможности раздельного ассемблирования

#### 1. **Множественные секции (CSECT)**
- Поддержка нескольких независимых управляющих секций в одной программе
- Каждая секция имеет собственную таблицу символов
- Автоматическое переключение между секциями

#### 2. **Внешние определения (EXTDEF)**
- Объявление символов, доступных для других модулей
- Автоматическое добавление в ТСИ с типом "ВИ" (внешнее имя)
- Валидация: имя должно быть определено в текущей секции

#### 3. **Внешние ссылки (EXTREF)**
- Объявление символов, определённых в других модулях
- Автоматическое добавление в ТСИ с типом "ВС" (внешняя ссылка)
- Специальная обработка при генерации кода (нулевой адрес + запись в таблицу настройки)

#### 4. **Расширенная таблица символических имен (ТСИ)**
- **Имя** - символическое имя
- **Адрес** - адрес в памяти (или -1 для внешних ссылок)
- **Секция** - имя секции, к которой относится символ
- **Тип** - тип символа:
  - "" (пусто) - обычный символ
  - "ВИ" - внешнее имя (EXTDEF)
  - "ВС" - внешняя ссылка (EXTREF)

#### 5. **Таблица настройки (ТН)**
Расширена для поддержки внешних связей:
- **Адрес** - адрес команды, требующей настройки
- **Метка** - имя внешней ссылки (если применимо)
- **Секция** - секция, к которой относится запись

#### 6. **Полный перемещаемый формат объектного кода**

Генерируемые записи:
- **H** (Header) - заголовок секции: `H имя_секции начальный_адрес длина`
- **D** (Define) - определение внешнего имени: `D имя адрес`
- **R** (Reference) - внешняя ссылка: `R имя`
- **T** (Text) - текстовая запись с кодом: `T адрес длина данные`
- **M** (Modification) - запись настройки: `M адрес [метка]`
- **E** (End) - конец секции: `E адрес_входа`

## Структура проекта

```
lab3/
├── CMakeLists.txt          # Файл сборки CMake
├── README.md               # Этот файл
├── include/                # Заголовочные файлы
│   ├── ui/
│   │   └── mainwindow.h
│   ├── assembler/
│   │   └── assembler.h
│   ├── parser/
│   │   └── parser.h
│   ├── structures/
│   │   ├── command.h
│   │   ├── operand.h
│   │   ├── symbolicname.h    # ← Расширен: секция, тип
│   │   ├── codeline.h
│   │   ├── section.h          # ← Новый: управляющая секция
│   │   └── tnline.h           # ← Новый: запись таблицы настройки
│   └── exceptions/
│       └── assemblerexception.h
├── src/                    # Исходные файлы
│   ├── main.cpp
│   ├── ui/
│   │   └── mainwindow.cpp
│   ├── assembler/
│   │   └── assembler.cpp      # ← Обновлён: EXTDEF, EXTREF, CSECT
│   ├── parser/
│   │   └── parser.cpp
│   ├── structures/
│   │   ├── command.cpp
│   │   ├── operand.cpp
│   │   ├── symbolicname.cpp
│   │   ├── codeline.cpp
│   │   ├── section.cpp        # ← Новый
│   │   └── tnline.cpp         # ← Новый
│   └── exceptions/
│       └── assemblerexception.cpp
└── ui/                     # UI файлы Qt Designer
    └── mainwindow.ui
```

## Требования

- **Qt 5** или выше
- **CMake 3.16** или выше
- **C++17**

## Сборка

### Через Qt Creator
1. Откройте `CMakeLists.txt` в Qt Creator
2. Настройте Kit (Desktop Qt 6.x.x)
3. Нажмите "Build"

### Через командную строку
```bash
mkdir build
cd build
cmake ..
cmake --build .
```

## Использование

1. **Запустите приложение**
2. **Введите исходный код** в левую панель (или выберите пример из выпадающего списка)
3. **Настройте таблицу команд** (по умолчанию загружены стандартные команды)
4. **Нажмите "Первый проход"** для создания ТСИ
5. **Нажмите "Второй проход"** для генерации объектного кода
6. **Просмотрите результаты**:
   - ТСИ с типами символов (ВИ/ВС)
   - Таблицу настройки (ТН) с внешними ссылками
   - Объектный код в полном перемещаемом формате

## Поддерживаемые директивы

### Базовые директивы
- `START` - начало первой секции программы
- `END` - конец программы (закрывает последнюю секцию)
- `WORD` - определение слова (3 байта)
- `BYTE` - определение байта или строки
- `RESW` - резервирование слов
- `RESB` - резервирование байтов

### Директивы раздельного ассемблирования
- **`EXTDEF имя`** - объявление внешнего имени (экспорт)
  - Должно быть определено в текущей секции
  - Может следовать только после START, CSECT, EXTDEF
  
- **`EXTREF имя`** - объявление внешней ссылки (импорт)
  - Ссылка на символ из другого модуля
  - Может следовать после START, CSECT, EXTDEF, EXTREF
  
- **`CSECT [адрес_входа]`** - начало новой управляющей секции
  - Закрывает предыдущую секцию
  - Должна иметь метку-имя секции
  - Опциональный операнд - адрес входа в предыдущую секцию

## Поддерживаемые команды

По умолчанию:
- **JMP** (код 1, длина 4) - безусловный переход
- **LOADR1** (код 2, длина 4) - загрузка в регистр R1
- **LOADR2** (код 3, длина 4) - загрузка в регистр R2
- **ADD** (код 4, длина 2) - сложение регистров
- **SAVER1** (код 5, длина 4) - сохранение регистра R1
- **INT** (код 6, длина 2) - программное прерывание

## Режимы адресации

### 1. Прямая адресация (Straight)
```assembly
LOADR1  LABEL    ; Абсолютный адрес LABEL
```
- Операнд содержит абсолютный адрес
- Добавляется в таблицу настройки
- Используется для обычных символов и внешних ссылок

### 2. Относительная адресация (Relative)
```assembly
JMP  [LABEL]     ; Смещение относительно текущей позиции
```
- Операнд в квадратных скобках
- Вычисляется смещение: `адрес_метки - адрес_следующей_команды`
- НЕ добавляется в таблицу настройки
- **НЕЛЬЗЯ** использовать с внешними ссылками

### 3. Смешанный режим (Mixed)
```assembly
JMP     [LOCAL]  ; Относительная
LOADR1  EXTERN   ; Прямая (внешняя ссылка)
```
- В одной программе используются оба режима
- Ассемблер автоматически определяет тип

## Примеры программ

### Пример 1: Прямая адресация с внешними связями
```assembly
MAIN    START   0
        EXTDEF  BUFFER
        EXTDEF  SIZE
        EXTREF  PRINT
        EXTREF  READ
SIZE    WORD    100
BUFFER  RESB    100
        LOADR1  SIZE
        LOADR2  BUFFER
        JMP     PRINT
        SAVER1  READ
        INT     0
IO      CSECT
        EXTDEF  PRINT
        EXTDEF  READ
        EXTREF  BUFFER
        EXTREF  SIZE
PRINT   LOADR1  BUFFER
        SAVER1  SIZE
        INT     1
READ    LOADR1  SIZE
        LOADR2  BUFFER
        INT     2
        END
```

**Особенности:**
- Две секции: MAIN и IO
- MAIN экспортирует BUFFER и SIZE, импортирует PRINT и READ
- IO экспортирует PRINT и READ, импортирует BUFFER и SIZE
- Все адресации - прямые

### Пример 2: Относительная адресация
```assembly
PROG  START   0
    EXTDEF  D23
    EXTDEF  D4
    EXTREF  D2
    EXTREF  D546
D4  RESB    10
D23 RESB    10
    JMP     [D4]
    SAVER1  [D23]
    RESB    10
A2  CSECT
    EXTDEF  D42
    EXTREF  D4
D42 SAVER1  [D42]
    INT     200
    END
```

**Особенности:**
- Используются квадратные скобки `[]` для относительной адресации
- Внутренние символы могут использоваться с относительной адресацией
- Внешние ссылки используются с прямой адресацией

### Пример 3: Смешанный режим
```assembly
PROG  START   0
    EXTDEF  D23
    EXTDEF  D4
    EXTREF  D2
    EXTREF  D546
D4  RESB    10
D23 RESB    10
    JMP     [D4]
    SAVER1  D546
    RESB    10
A2  CSECT
    EXTDEF  D42
    EXTREF  D4
D42 SAVER1  D4
    INT     200
    END
```

**Особенности:**
- Комбинация прямой и относительной адресации
- Внутренние метки могут использовать оба режима
- Внешние ссылки только с прямой адресацией
- Команда с двумя регистрами: `ADD R1 R2`

## Формат объектного кода

### Структура для каждой секции:

```
H имя_секции    начальный_адрес    длина_секции
D имя_1         адрес_1
D имя_2         адрес_2
R внешняя_ссылка_1
R внешняя_ссылка_2
T адрес  длина  данные
T адрес  длина  данные
...
M адрес  [имя_внешней_ссылки]
M адрес  [имя_внешней_ссылки]
...
E адрес_входа
```

### Пример вывода:

```
H MAIN      000000  000019
D BUFFER    00000A
D SIZE      000000
R PRINT
R READ
T 000000    03      000064
T 000004    04      05000000
T 00000A    0A
T 000014    04      05000000
M 000006    PRINT
M 000016    READ
E 000000

H IO        000000  000016
D PRINT     000000
D READ      00000A
R BUFFER
R SIZE
T 000000    04      09000000
T 000004    04      15000000
M 000002    BUFFER
M 000006    SIZE
E 000000
```

## Алгоритм работы

### Первый проход

1. **Инициализация**
   - Очистка ТСИ, таблицы секций
   - Установка ip = 0
   - Инициализация текущей секции

2. **Обработка директив START/CSECT**
   - Создание новой секции
   - Сохранение предыдущей секции (для CSECT)
   - Установка имени и начального адреса

3. **Обработка EXTDEF/EXTREF**
   - Валидация порядка директив
   - Добавление в ТСИ с типом "ВИ" или "ВС"
   - Для EXTDEF: адрес = -1 (будет установлен позже)
   - Для EXTREF: адрес = -1 (внешняя ссылка)

4. **Обработка меток**
   - Добавление в ТСИ с текущим адресом
   - Если метка была объявлена через EXTDEF, обновить её адрес

5. **Обработка команд и данных**
   - Инкремент счётчика адреса (ip)
   - Генерация промежуточного кода

6. **Финализация**
   - Проверка, что все EXTDEF получили адреса
   - Сохранение последней секции

### Второй проход

1. **Инициализация**
   - Очистка ТН
   - Установка индекса текущей секции

2. **Генерация заголовка (H)**
   - Для каждой секции: имя, адрес, длина

3. **Генерация определений (D)**
   - Для каждого EXTDEF в секции: имя и адрес

4. **Генерация ссылок (R)**
   - Для каждого EXTREF в секции: имя

5. **Генерация кода (T)**
   - Обработка команд и данных
   - Для внешних ссылок: использовать адрес 0
   - Для относительной адресации: вычислить смещение
   - Добавление записей в ТН

6. **Генерация настроек (M)**
   - Для каждой записи ТН в секции: адрес и метка

7. **Генерация конца (E)**
   - Адрес входа в секцию

## Детали реализации

### Структура данных

#### Section (section.h/cpp)
```cpp
class Section {
    std::string name_;        // Имя секции
    int startAddress_;        // Начальный адрес
    int endAddress_;          // Адрес входа
    int length_;              // Длина секции
};
```

#### SymbolicName (symbolicname.h/cpp)
```cpp
class SymbolicName {
    std::string name_;        // Имя символа
    int address_;             // Адрес (-1 для внешних)
    std::string section_;     // Имя секции
    std::string type_;        // "" / "ВИ" / "ВС"
};
```

#### TNLine (tnline.h/cpp)
```cpp
class TNLine {
    std::string address_;     // Адрес настройки
    std::string label_;       // Имя внешней ссылки
    std::string section_;     // Имя секции
};
```

### Ключевые методы Assembler

#### Первый проход
- `processExtdefDirective()` - обработка EXTDEF
- `processExtrefDirective()` - обработка EXTREF
- `processCsectDirective()` - обработка CSECT
- `pushToTSI()` - добавление символа с проверкой типа
- `tsiCheck()` - проверка, что все EXTDEF получили адреса
- `orderCheck()` - проверка порядка директив

#### Второй проход
- `processSecondPassExtdef()` - генерация D-записи
- `processSecondPassExtref()` - генерация R-записи
- `processSecondPassCommand()` - обработка команд с учётом внешних ссылок
- `pushToTN()` - добавление записи в таблицу настройки

## Валидация и проверка ошибок

### Первый проход
- Порядок директив (EXTDEF/EXTREF после START/CSECT)
- Уникальность имён секций
- Уникальность символов в пределах секции
- Операнды EXTDEF/EXTREF - корректные метки
- Все EXTDEF получили адреса
- Переполнение памяти

### Второй проход
- Все символы определены или объявлены как внешние
- Относительная адресация не используется с внешними ссылками
- Корректный адрес входа в секцию

## Известные ограничения

- Максимальный адрес: 16777215 (2^24 - 1, 3 байта)
- Максимальное количество регистров: R1-R16
- Длина имени метки: до 10 символов
- Поддерживаемые длины команд: 1, 2 или 4 байта

